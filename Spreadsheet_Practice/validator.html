<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verification Code Checker</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .container {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .upload-section {
            text-align: center;
            padding: 40px 20px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #fff;
            transition: all 0.3s;
        }
        .upload-section:hover {
            border-color: #3498db;
        }
        .upload-section.dragover {
            background-color: #ecf0f1;
            border-color: #3498db;
        }
        #file-upload {
            display: none;
        }
        .upload-btn {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .upload-btn:hover {
            background-color: #2980b9;
        }
        #uploaded-file-name {
            margin-top: 10px;
            font-style: italic;
        }
        .process-btn {
            background-color: #2ecc71;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        .process-btn:hover {
            background-color: #27ae60;
        }
        .process-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .format-example {
            margin: 30px 0;
            padding: 15px;
            background-color: #f5f9ff;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .format-example h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        .format-example table {
            width: 100%;
            max-width: 600px;
            margin: 15px 0;
            border-collapse: collapse;
        }
        .format-example th {
            background-color: #34495e;
            color: white;
            padding: 8px;
            text-align: left;
        }
        .format-example td {
            padding: 8px;
            border: 1px solid #ddd;
        }
        .format-example tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        #results-section {
            margin-top: 30px;
            display: none;
        }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .download-btn {
            background-color: #f39c12;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .download-btn:hover {
            background-color: #e67e22;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .results-table th {
            background-color: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
        }
        .results-table td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .results-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .results-table tr:hover {
            background-color: #e6f7ff;
        }
        .alert {
            color: #e74c3c;
            font-weight: bold;
        }
        .status {
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
        }
        .success {
            color: #2ecc71;
        }
        .error {
            color: #e74c3c;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3498db;
            animation: spin 1s linear infinite;
            margin: 0 auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f4f8;
            border-radius: 4px;
            display: none;
        }
        #preview-table-container {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        .limited-preview {
            font-style: italic;
            text-align: center;
            margin-top: 10px;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Verification Code Checker</h1>

        <div class="upload-section" id="drop-area">
            <label for="file-upload" class="upload-btn">Choose CSV File</label>
            <input type="file" id="file-upload" accept=".csv" />
            <p>or drag and drop your CSV file here</p>
            <div id="uploaded-file-name"></div>
        </div>

        <div class="format-example">
            <h3>Input Format Example</h3>
            <p>Your CSV file should follow this format - with student names in the first column and verification codes in lesson columns:</p>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>1</th>
                        <th>2</th>
                        <th>3</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Claude</td>
                        <td>DEPAJ1</td>
                        <td>DICAQ2</td>
                        <td>DOQAX3</td>
                    </tr>
                    <tr>
                        <td>ChatGPT</td>
                        <td>DEMOK1</td>
                        <td>DIXES2</td>
                        <td>DOJIB3</td>
                    </tr>
                </tbody>
            </table>
            <p>Note: The verification codes shown above are valid examples generated by the system. Your students' codes will be different.</p>
        </div>

        <div class="status" id="status"></div>
        <div class="spinner" id="spinner"></div>

        <button id="process-btn" class="process-btn" disabled>Process Verification Codes</button>

        <div id="summary"></div>

        <div id="results-section">
            <div class="results-header">
                <h2>Results Preview</h2>
                <button id="download-btn" class="download-btn">Download Results CSV</button>
            </div>
            <div id="preview-table-container">
                <table id="results-table" class="results-table">
                    <!-- Results will be inserted here -->
                </table>
            </div>
            <p class="limited-preview">Showing preview of results (limited to 20 rows).</p>
        </div>
    </div>

    <script>
        // Include the verification.js code
        // Verification code generator for spreadsheet lessons
        // Creates a simple verification code based on student name and lesson number

        /**
         * Generates a verification code from student name and lesson number
         * @param {string} name - Student's name
         * @param {number} lessonNum - Lesson number completed
         * @return {string} A verification code (5-6 characters)
         */
        function makeVerification(name, lessonNum) {
            // Normalize the name: trim, convert to lowercase, remove non-alphanumeric characters
            const normalizedName = name.trim().toLowerCase().replace(/[^a-z0-9]/g, '');

            if (normalizedName.length === 0) {
                // If no valid characters in name, use a fallback
                return "ANON" + lessonNum + "X";
            }

            // Create a seed based on name and lesson number
            const seed = calculateNameSeed(normalizedName) * lessonNum;

            // Generate a deterministic but seemingly random code
            return generateCode(seed, normalizedName, lessonNum);
        }

        /**
         * Calculates a numeric seed from a name
         * @param {string} name - Normalized name
         * @return {number} A numeric value derived from the name
         */
        function calculateNameSeed(name) {
            let seed = 0;

            // Sum character codes with position-based weighting
            for (let i = 0; i < name.length; i++) {
                // Different weighting for even/odd positions
                if (i % 2 === 0) {
                    seed += name.charCodeAt(i) * (i + 1);
                } else {
                    seed += name.charCodeAt(i) * (i * 2 + 1);
                }
            }

            // Additional transformation
            seed = (seed * 13) % 10000;

            return seed;
        }

        /**
         * Generates a verification code from the seed, name, and lesson number
         * @param {number} seed - Numeric seed
         * @param {string} name - Normalized name
         * @param {number} lessonNum - Lesson number
         * @return {string} A verification code
         */
        function generateCode(seed, name, lessonNum) {
            // Define character sets for the code
            const consonants = 'BCDFGHJKLMNPQRSTVWXYZ';
            const vowels = 'AEIOU';

            let code = '';

            // Start with a consonant based on the first letter of the name
            const firstCharIndex = Math.abs(name.charCodeAt(0) - 97) % consonants.length;
            code += consonants[firstCharIndex];

            // Add a vowel based on lesson number
            code += vowels[lessonNum % vowels.length];

            // Add two characters based on the seed
            code += consonants[seed % consonants.length];
            code += vowels[(seed % 17) % vowels.length];

            // Add a character based on the name length
            code += consonants[(name.length * lessonNum) % consonants.length];

            // Add suffix based on lesson number for more differentiation between lessons
            if (lessonNum > 9) {
                code += lessonNum;
            } else {
                code += lessonNum;
            }

            return code;
        }

        // Papa Parse for CSV parsing
        document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"><\/script>');

        // Main application code
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const dropArea = document.getElementById('drop-area');
            const fileUpload = document.getElementById('file-upload');
            const uploadedFileName = document.getElementById('uploaded-file-name');
            const processBtn = document.getElementById('process-btn');
            const resultsSection = document.getElementById('results-section');
            const resultsTable = document.getElementById('results-table');
            const downloadBtn = document.getElementById('download-btn');
            const statusEl = document.getElementById('status');
            const spinner = document.getElementById('spinner');
            const summaryEl = document.getElementById('summary');

            // Variables
            let csvData = null;
            let processedData = null;
            let fileName = '';

            // Event listeners for drag and drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                dropArea.classList.add('dragover');
            }

            function unhighlight() {
                dropArea.classList.remove('dragover');
            }

            // Handle dropped files
            dropArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }

            function handleFiles(files) {
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                        fileName = file.name;
                        uploadedFileName.textContent = `Selected file: ${fileName}`;
                        readFile(file);
                    } else {
                        statusEl.textContent = 'Error: Please upload a CSV file.';
                        statusEl.className = 'status error';
                    }
                }
            }

            // File input change handler
            fileUpload.addEventListener('change', function(e) {
                handleFiles(e.target.files);
            });

            // Read the file
            function readFile(file) {
                statusEl.textContent = 'Reading file...';
                statusEl.className = 'status';
                spinner.style.display = 'block';

                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        spinner.style.display = 'none';

                        if (results.data.length > 500) {
                            statusEl.textContent = 'Error: Maximum 500 rows allowed.';
                            statusEl.className = 'status error';
                            return;
                        }

                        if (!results.data[0].hasOwnProperty('Name')) {
                            statusEl.textContent = 'Error: CSV must have a "Name" column.';
                            statusEl.className = 'status error';
                            return;
                        }

                        // Check for at least one numeric column
                        let hasNumericColumn = false;
                        for (const header of results.meta.fields) {
                            if (!isNaN(parseInt(header)) && header !== '') {
                                hasNumericColumn = true;
                                break;
                            }
                        }

                        if (!hasNumericColumn) {
                            statusEl.textContent = 'Error: CSV must have at least one numeric column (lesson number).';
                            statusEl.className = 'status error';
                            return;
                        }

                        csvData = results.data;
                        statusEl.textContent = `File loaded successfully with ${csvData.length} records.`;
                        statusEl.className = 'status success';
                        processBtn.disabled = false;
                    },
                    error: function(error) {
                        spinner.style.display = 'none';
                        statusEl.textContent = `Error: ${error.message}`;
                        statusEl.className = 'status error';
                    }
                });
            }

            // Process button click handler
            processBtn.addEventListener('click', processData);

            function processData() {
                if (!csvData) return;

                statusEl.textContent = 'Processing...';
                statusEl.className = 'status';
                spinner.style.display = 'block';
                processBtn.disabled = true;

                // Delay processing to allow UI to update
                setTimeout(function() {
                    try {
                        processedData = processVerificationCodes(csvData);
                        displayResults(processedData);

                        // Generate summary
                        generateSummary(processedData);

                        statusEl.textContent = 'Processing complete.';
                        statusEl.className = 'status success';
                    } catch (error) {
                        statusEl.textContent = `Error: ${error.message}`;
                        statusEl.className = 'status error';
                    } finally {
                        spinner.style.display = 'none';
                        processBtn.disabled = false;
                    }
                }, 100);
            }

            // Process verification codes
            function processVerificationCodes(data) {
                const processedData = [];
                const headers = Object.keys(data[0]);

                const lessonHeaders = headers.filter(header => {
                    const num = parseInt(header);
                    return !isNaN(num) && header !== '';
                }).sort((a, b) => parseInt(a) - parseInt(b));

                // Process each row (student)
                data.forEach(row => {
                    const newRow = { Name: row.Name };
                    let hasAlert = false;

                    // Process each lesson column
                    lessonHeaders.forEach(lessonHeader => {
                        const lessonNum = parseInt(lessonHeader);
                        const submittedCode = row[lessonHeader] || '';

                        if (submittedCode === '') {
                            // Empty code
                            newRow[lessonHeader] = '0';
                        } else {
                            // Generate expected verification code
                            const expectedCode = makeVerification(row.Name, lessonNum);

                            // Compare submitted code with expected code
                            if (submittedCode.toString().toUpperCase() === expectedCode) {
                                newRow[lessonHeader] = '1';
                            } else {
                                newRow[lessonHeader] = '0';
                                hasAlert = true;
                            }
                        }
                    });

                    // Add alert column
                    newRow['ALERT'] = hasAlert ? 'INCORRECT CODE' : '';

                    processedData.push(newRow);
                });

                return processedData;
            }

            // Display results preview
            function displayResults(data) {
                resultsTable.innerHTML = '';

                // Create header row
                const headerRow = document.createElement('tr');
                const headers = Object.keys(data[0]);

                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });

                resultsTable.appendChild(headerRow);

                // Create data rows (limited to 20 for preview)
                const previewLimit = Math.min(data.length, 20);

                for (let i = 0; i < previewLimit; i++) {
                    const dataRow = document.createElement('tr');

                    headers.forEach(header => {
                        const td = document.createElement('td');
                        td.textContent = data[i][header];

                        // Highlight alert cells
                        if (header === 'ALERT' && data[i][header]) {
                            td.className = 'alert';
                        }

                        dataRow.appendChild(td);
                    });

                    resultsTable.appendChild(dataRow);
                }

                resultsSection.style.display = 'block';
            }

            // Generate summary
            function generateSummary(data) {
                const headers = Object.keys(data[0]).filter(header => {
                    return !isNaN(parseInt(header)) && header !== '';
                });

                let summaryHTML = '<h3>Summary</h3><ul>';

                // Calculate totals for each lesson
                headers.forEach(lessonHeader => {
                    const correctCount = data.filter(row => row[lessonHeader] === '1').length;
                    const totalCount = data.length;
                    const percentage = ((correctCount / totalCount) * 100).toFixed(1);

                    summaryHTML += `<li>Lesson ${lessonHeader}: ${correctCount} correct out of ${totalCount} (${percentage}%)</li>`;
                });

                // Count students with alerts
                const alertCount = data.filter(row => row['ALERT']).length;
                summaryHTML += `<li><strong>Total students with incorrect codes: ${alertCount}</strong></li>`;

                summaryHTML += '</ul>';
                summaryEl.innerHTML = summaryHTML;
                summaryEl.style.display = 'block';
            }

            // Download button click handler
            downloadBtn.addEventListener('click', downloadResults);

            function downloadResults() {
                if (!processedData) return;

                // Convert processed data to CSV
                const csv = Papa.unparse(processedData);

                // Create download link
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');

                link.setAttribute('href', url);
                link.setAttribute('download', `verified_${fileName}`);
                link.style.visibility = 'hidden';

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });
    </script>
</body>
</html>
