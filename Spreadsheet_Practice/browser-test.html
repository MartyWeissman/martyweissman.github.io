<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spreadsheet Browser Compatibility Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }

        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f1b0b7;
        }

        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .overall-result {
            font-size: 1.2em;
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border: 2px solid;
        }

        .browser-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Spreadsheet Browser Compatibility Test</h1>

    <div class="browser-info">
        <h3>Your Browser Information:</h3>
        <p><strong>User Agent:</strong> <span id="userAgent"></span></p>
        <p><strong>Browser:</strong> <span id="browserName"></span></p>
        <p><strong>Version:</strong> <span id="browserVersion"></span></p>
    </div>

    <h3>Compatibility Test Results:</h3>
    <div id="testResults"></div>

    <div id="overallResult" class="overall-result"></div>

    <h3>Test Actions:</h3>
    <button onclick="runAllTests()">Run All Tests</button>
    <button onclick="testLessonNavigation()">Test Lesson Navigation</button>
    <button onclick="clearResults()">Clear Results</button>

    <h3>What This Tests:</h3>
    <ul>
        <li><strong>URLSearchParams:</strong> The main cause of navigation failures</li>
        <li><strong>DOM Manipulation:</strong> Required for spreadsheet functionality</li>
        <li><strong>Event Handling:</strong> Needed for user interactions</li>
        <li><strong>JavaScript Features:</strong> Core language features used</li>
        <li><strong>Local Storage:</strong> For saving student progress</li>
    </ul>

    <script>
        // Display browser information
        function displayBrowserInfo() {
            document.getElementById('userAgent').textContent = navigator.userAgent;

            // Simple browser detection
            var browserName = "Unknown";
            var browserVersion = "Unknown";

            if (navigator.userAgent.indexOf("Chrome") > -1) {
                browserName = "Chrome";
                var match = navigator.userAgent.match(/Chrome\/([0-9]+)/);
                if (match) browserVersion = match[1];
            } else if (navigator.userAgent.indexOf("Firefox") > -1) {
                browserName = "Firefox";
                var match = navigator.userAgent.match(/Firefox\/([0-9]+)/);
                if (match) browserVersion = match[1];
            } else if (navigator.userAgent.indexOf("Safari") > -1 && navigator.userAgent.indexOf("Chrome") === -1) {
                browserName = "Safari";
                var match = navigator.userAgent.match(/Version\/([0-9]+)/);
                if (match) browserVersion = match[1];
            } else if (navigator.userAgent.indexOf("Edge") > -1) {
                browserName = "Edge";
                var match = navigator.userAgent.match(/Edge\/([0-9]+)/);
                if (match) browserVersion = match[1];
            } else if (navigator.userAgent.indexOf("MSIE") > -1 || navigator.userAgent.indexOf("Trident") > -1) {
                browserName = "Internet Explorer";
                var match = navigator.userAgent.match(/(?:MSIE |rv:)([0-9]+)/);
                if (match) browserVersion = match[1];
            }

            document.getElementById('browserName').textContent = browserName;
            document.getElementById('browserVersion').textContent = browserVersion;
        }

        // Test result storage
        var testResults = [];

        // Add test result
        function addTestResult(testName, passed, message) {
            testResults.push({
                name: testName,
                passed: passed,
                message: message
            });

            var resultsDiv = document.getElementById('testResults');
            var resultDiv = document.createElement('div');
            resultDiv.className = 'test-result ' + (passed ? 'pass' : 'fail');
            resultDiv.innerHTML = '<strong>' + testName + ':</strong> ' + message;
            resultsDiv.appendChild(resultDiv);
        }

        // Clear results
        function clearResults() {
            testResults = [];
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('overallResult').innerHTML = '';
        }

        // Test URLSearchParams (main issue)
        function testURLSearchParams() {
            try {
                var url = new URL('http://example.com?test=value');
                var params = new URLSearchParams(url.search);
                var value = params.get('test');

                if (value === 'value') {
                    addTestResult('URLSearchParams Support', true, 'PASS - Modern URL parameter parsing works');
                } else {
                    addTestResult('URLSearchParams Support', false, 'FAIL - URLSearchParams exists but returns wrong value');
                }
            } catch (e) {
                addTestResult('URLSearchParams Support', false, 'FAIL - URLSearchParams not supported (this was the main bug!)');
            }
        }

        // Test fallback URL parameter parsing
        function testFallbackURLParsing() {
            try {
                // Test the fallback method used in the fix
                function getURLParam(name) {
                    var results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec('?test=value&other=123');
                    return results === null ? null : decodeURIComponent(results[1]) || null;
                }

                var result = getURLParam('test');
                if (result === 'value') {
                    addTestResult('Fallback URL Parsing', true, 'PASS - Regex-based URL parsing works');
                } else {
                    addTestResult('Fallback URL Parsing', false, 'FAIL - Regex URL parsing failed');
                }
            } catch (e) {
                addTestResult('Fallback URL Parsing', false, 'FAIL - Regex parsing error: ' + e.message);
            }
        }

        // Test DOM manipulation
        function testDOMManipulation() {
            try {
                var testDiv = document.createElement('div');
                testDiv.className = 'test-element';
                testDiv.innerHTML = 'Test content';
                document.body.appendChild(testDiv);

                var found = document.querySelector('.test-element');
                if (found && found.innerHTML === 'Test content') {
                    addTestResult('DOM Manipulation', true, 'PASS - createElement, className, innerHTML, querySelector work');
                    document.body.removeChild(testDiv);
                } else {
                    addTestResult('DOM Manipulation', false, 'FAIL - DOM manipulation failed');
                }
            } catch (e) {
                addTestResult('DOM Manipulation', false, 'FAIL - DOM error: ' + e.message);
            }
        }

        // Test event handling
        function testEventHandling() {
            try {
                var testButton = document.createElement('button');
                var eventFired = false;

                // Test both modern and old event handling
                if (testButton.addEventListener) {
                    testButton.addEventListener('click', function() {
                        eventFired = true;
                    });
                    addTestResult('Event Handling (Modern)', true, 'PASS - addEventListener supported');
                } else if (testButton.attachEvent) {
                    testButton.attachEvent('onclick', function() {
                        eventFired = true;
                    });
                    addTestResult('Event Handling (Legacy)', true, 'PASS - attachEvent supported (IE8 style)');
                } else {
                    addTestResult('Event Handling', false, 'FAIL - No event handling method found');
                }

                // Test onclick as fallback
                testButton.onclick = function() {
                    eventFired = true;
                };

                if (typeof testButton.onclick === 'function') {
                    addTestResult('Event Handling (onclick)', true, 'PASS - onclick property supported');
                } else {
                    addTestResult('Event Handling (onclick)', false, 'FAIL - onclick not supported');
                }

            } catch (e) {
                addTestResult('Event Handling', false, 'FAIL - Event handling error: ' + e.message);
            }
        }

        // Test JavaScript features
        function testJavaScriptFeatures() {
            try {
                // Test array methods
                var arr = [1, 2, 3];
                var doubled = [];
                for (var i = 0; i < arr.length; i++) {
                    doubled.push(arr[i] * 2);
                }

                if (doubled.length === 3 && doubled[0] === 2) {
                    addTestResult('Basic JavaScript', true, 'PASS - Arrays, loops, basic operations work');
                } else {
                    addTestResult('Basic JavaScript', false, 'FAIL - Basic JavaScript operations failed');
                }

                // Test object handling
                var obj = { test: 'value' };
                if (obj.test === 'value' && obj['test'] === 'value') {
                    addTestResult('Object Handling', true, 'PASS - Object property access works');
                } else {
                    addTestResult('Object Handling', false, 'FAIL - Object handling failed');
                }

                // Test function declarations
                function testFunc() {
                    return 'working';
                }

                if (typeof testFunc === 'function' && testFunc() === 'working') {
                    addTestResult('Function Support', true, 'PASS - Function declarations work');
                } else {
                    addTestResult('Function Support', false, 'FAIL - Function declarations failed');
                }

            } catch (e) {
                addTestResult('JavaScript Features', false, 'FAIL - JavaScript error: ' + e.message);
            }
        }

        // Test local storage
        function testLocalStorage() {
            try {
                if (typeof Storage !== 'undefined') {
                    localStorage.setItem('test', 'value');
                    var retrieved = localStorage.getItem('test');
                    localStorage.removeItem('test');

                    if (retrieved === 'value') {
                        addTestResult('Local Storage', true, 'PASS - Local storage works (useful for saving progress)');
                    } else {
                        addTestResult('Local Storage', false, 'FAIL - Local storage exists but doesn\'t work properly');
                    }
                } else {
                    addTestResult('Local Storage', false, 'WARN - Local storage not supported (progress won\'t be saved)');
                }
            } catch (e) {
                addTestResult('Local Storage', false, 'WARN - Local storage error: ' + e.message);
            }
        }

        // Test lesson navigation simulation
        function testLessonNavigation() {
            try {
                // Simulate the lesson loading process
                var lessonNum = 2;
                var scriptId = 'current-lesson-script';

                // Remove existing script (if any)
                var existingScript = document.getElementById(scriptId);
                if (existingScript) {
                    existingScript.parentNode.removeChild(existingScript);
                }

                // Create new script element
                var script = document.createElement('script');
                script.id = scriptId;
                script.type = 'text/javascript';

                // Test if we can create and manipulate script elements
                if (script && script.id === scriptId) {
                    addTestResult('Lesson Navigation Simulation', true, 'PASS - Can create and manage lesson scripts');
                } else {
                    addTestResult('Lesson Navigation Simulation', false, 'FAIL - Cannot manage lesson scripts');
                }

            } catch (e) {
                addTestResult('Lesson Navigation Simulation', false, 'FAIL - Lesson navigation error: ' + e.message);
            }
        }

        // Run all tests
        function runAllTests() {
            clearResults();

            testURLSearchParams();
            testFallbackURLParsing();
            testDOMManipulation();
            testEventHandling();
            testJavaScriptFeatures();
            testLocalStorage();
            testLessonNavigation();

            // Calculate overall result
            var totalTests = testResults.length;
            var passedTests = testResults.filter(function(test) { return test.passed; }).length;
            var failedTests = totalTests - passedTests;

            var overallDiv = document.getElementById('overallResult');

            if (failedTests === 0) {
                overallDiv.className = 'overall-result pass';
                overallDiv.innerHTML = '✅ ALL TESTS PASSED (' + passedTests + '/' + totalTests + ')<br>This browser should work perfectly with the spreadsheet application!';
            } else if (failedTests <= 2) {
                overallDiv.className = 'overall-result warning';
                overallDiv.innerHTML = '⚠️ MOSTLY COMPATIBLE (' + passedTests + '/' + totalTests + ' passed)<br>This browser should work, but may have minor issues.';
            } else {
                overallDiv.className = 'overall-result fail';
                overallDiv.innerHTML = '❌ COMPATIBILITY ISSUES (' + failedTests + ' failures)<br>This browser may have problems with the spreadsheet application.';
            }
        }

        // Initialize on page load
        displayBrowserInfo();

        // Auto-run tests after a short delay
        setTimeout(runAllTests, 500);
    </script>
</body>
</html>
